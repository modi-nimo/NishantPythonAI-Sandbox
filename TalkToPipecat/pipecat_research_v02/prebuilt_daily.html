<html>
  <script crossorigin src="https://unpkg.com/@daily-co/daily-js"></script>
  <body style="margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column;">
    <div style="padding: 10px; background-color: #f0f0f0; display: flex; align-items: center;">
      <input type="text" id="roomUrl" placeholder="Enter room URL" style="flex-grow: 1; padding: 8px; margin-right: 10px;" />
      <button id="connectButton" style="padding: 8px 15px; cursor: pointer;">Connect</button>
    </div>
    <div id="daily-frame" style="flex-grow: 1; width: 100%; height: 100%;"></div>
    <script>
      const roomUrlInput = document.getElementById('roomUrl');
      const connectButton = document.getElementById('connectButton');
      const dailyFrameContainer = document.getElementById('daily-frame');
      let call;

      // Function to update the button text
      const updateButtonText = () => {
        if (roomUrlInput.value.trim() === '') {
          connectButton.textContent = 'Connect Dynamic Room';
        } else {
          connectButton.textContent = 'Connect';
        }
      };

      // Initial call to set the button text
      updateButtonText();

      // Listen for input changes to update the button text
      roomUrlInput.addEventListener('input', updateButtonText);

      connectButton.addEventListener('click', () => {
        const dailyRoomUrl = roomUrlInput.value.trim();
        const isDynamicRoom = dailyRoomUrl === '';
        let url = `http://localhost:7860/connect`;

        if (isDynamicRoom) {
          url += `?is_dynamic_room=true`;
        } else {
          url += `?room_url=${dailyRoomUrl}`;
        }

        if (call) {
          call.destroy(); // Destroy existing call if any
        }

        // Fetch the WebSocket URL and Room URL from the backend
        fetch(url, {
          method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
          const wsUrl = data.ws_url;
          const roomUrlToJoin = data.room_url;
          console.log("Connecting bot to WebSocket:", wsUrl);

          // Create a new WebSocket connection for the bot
          const botWs = new WebSocket(wsUrl);

          botWs.onopen = () => {
            console.log("Bot WebSocket connection established.");
          };

          botWs.onclose = () => {
            console.log("Bot WebSocket connection closed.");
          };

          botWs.onerror = (error) => {
            console.error("Bot WebSocket error:", error);
          };

          // Join the Daily.co room in the main frame using the URL from the backend
          call = window.Daily.createFrame(dailyFrameContainer, {
            showLeaveButton: true,
            iframeStyle: {
              position: 'absolute',
              top: '0',
              left: '0',
              width: '100%',
              height: '100%',
            },
          });
          call.join({ url: roomUrlToJoin });
        })
        .catch(error => {
          console.error("Error connecting to bot backend:", error);
          alert('Failed to connect the bot. Please check the backend server.');
        });
      });
    </script>
  </body>
</html>